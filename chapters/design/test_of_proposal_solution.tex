\section{Test of proposal solution}
This chapter aims to design the measurement for the proposed solution. The measurement is based on an L-acoustics KUDO line source array, which is described as the first part of this chapter. Afterwards, the measuring setup for both crosswind and parallel wind is designed based on the used line source array and concert conditions. The second part of this chapter deals with the wind noise challenge in outdoor measurement. The end of this chapter design the measurement software and the needed sensors. 



\section{Description of the used line source array}\label{sec:prop:des_of_lin}

The description of the used line source array starts with an introduction to the line source element, where the frequency response of the single element is measured as well as the directional characteristics. In the end, the horizontal directionally control, and the vertical directionally control is explained.

The line source elements which is used to test the proposed solution is an L-Acoustics KUDO line source array. This line source array is a legacy long throw variable curvature speaker. This speaker is today renewed and renamed to L-acoustics K2. The line source array can be flown as a vertical line with a maximum of 21 elements. The maximum number of an element is due to the safety limit on the flying tools. 
One single element have a frequency response from \Hz{50} to \SI{18}{\kilo\hertz} with a approximatly deviation of $\pm$ \dB{3} and have a maximum \gls{spl} of \dB{140} at \SI{1}{\meter}. The following \autoref{fig:ap:kudo_freq_resp} shows a frequency response measurement of a single KUDO line source element in \SI{50}{\degree} horizontal angle. 

\plot{plot/kudo_freq_resp}{The graph shows the frontal frequency response in \SI{50}{\degree} horizontal angle}{fig:ap:kudo_freq_resp}

This measurement in \autoref{fig:ap:kudo_freq_resp} is done in the anechoic chamber at Aalborg University as well as the following measurement in this section. The measurement is explained in \autoref{ap:dir_of_kudo}. The horizontal coverage angle of the L-Acoustics KUDO can be controlled individually on every line source element. The line source element allows both symmetric horizontal coverage and asymmetric coverage. The angle from the frontal direction to the outer main lobe \dB{-6} is either \SI{25}{\degree} or \SI{55}{\degree}. By this two angle for both sides, four coverage angle of the speaker is possible, \SI{110}{\degree}, \SI{50}{\degree} and \SI{80}{\degree} ether to the left or the right. To obtain a better resolution that only the \dB{-6} the directionality characteristics is measured in all settings. The measurement can be founded in \autoref{ap:dir_of_kudo} . The interesting settings while rotating the line source array is \SI{25}{\degree} / \SI{25}{\degree} and \SI{25}{\degree} / \SI{55}{\degree} which is shown in \autoref{fig:ap:KUDO_25_25_des} and \autoref{fig:ap:KUDO_25_55_des} respectivly.

\plot{plot/KUDO_25_25_isobar_design}{The graph shows a contour plot with \dB{3} step of the directionally of the L-acoustics KUDO with \SI{25}{\degree} / \SI{25}{\degree} settings. The lower black contour line indicate the \db directionality for the maximum rotation of the speaker}{fig:ap:KUDO_25_25_des}

\plot{plot/KUDO_25_55_isobar_design}{The graph shows a contour plot with \dB{3} step of the directionally of the L-acoustics KUDO with \SI{25}{\degree} / \SI{55}{\degree} settings. The lower black contour line indicate the \db directionality for the maximum rotation of the speaker}{fig:ap:KUDO_25_55_des}

The mechanical directional characteristics solution in the L-acoustics KUDO as well as other line source array element is not made for wind challenge but for neighbouring disruptions and higher \gls{spl} in the main lobe of the high frequency. All solution used today is only possible to be changed by hand and is not electrically controlled. The method for changing the horizontal directivity in the L-Acoustics KUDO line source element is two plexiglass plate fixed to the front grill. The fixing mechanism can be adjusted sidewise by realising two splits on both plexiglass plates. The plate can then be slid along the grill to change the mouth of the speaker output. The following \autoref{fig:td:kud_dir} illustrate the principle.

\fig{kudo_directivity.pdf}{The figure shows how the horizontal directivity is controlled on a L-Acoustics KUDO line source array element \citep{KUDO_manual}.}{fig:td:kud_dir}{0.8}
While the plexiglass plates are in \SI{55}{\degree} mode as shown in \autoref{fig:td:kud_dir}, the wider directionallity is obtained by soundwave reflection on the plexiglass plate.

The line source array vertically coverage area can be controlled from \SI{0}{\degree} to \SI{10}{\degree} with \SI{1}{\degree} step size. To be able to control the vertical main lobe of the line source array, the mechanical solution is the angle between the line source element. This means that the vertical coverage control cannot be controlled on the individual line source element as the horizontal coverage. To be able to control the vertical coverage, the speaker is trapeze designed such that the high frequency horn throat stays together while the angle between the elements is adjusted in the back of the element. The following \autoref{fig:td:kud_dir_ver} shows how the line source element are angled vertically.

\fig{vertical_coverage_adjust.pdf}{The figure shows how the vertical directivity is controlled on a L-Acoustics KUDO line source array element \citep{KUDO_rig}.}{fig:td:kud_dir_ver}{0.5}

To be able to fix the vertical coverage on the L-acoustics KUDO, the upper left rigging pin shall only be placed into the line source element rig when the angle shown on the metal pease shows the desired vertical coverage angle between two line source element.  


\section{Designing the measurement}\label{sec:des:des_mes}
This section aims to design a measurement based on the proposed solution \autoref{sec:td:pro_sol_pro} and the properties of the used line source array founded in the previous section. The first part of this section gives a general overwrite of the measuring setup. Afterwards, the independent measurement structure is designed for the crosswind and the parallel wind, respectively.


\subsection{General measuring setup}\label{sec:pro:test_setup}
The line source measurement setup is designed such that the proposed solution can be tested without mechanical change of the line source array. The test setup, therefore, do not change the speaker directionality along with the measurement. Furthermore, the amount of available line source array for the measurement is limited to six line source element. The following \autoref{fig:td:tes_set} shows the line source speaker setup and start vertical angling for both the crosswind and side wind measurement. 

\xfig{design/test_setup.pdf_t}{The figure shows test setup for both beasurement}{fig:td:tes_set}{1}

The vertical angle between the line source elements is \SI{0}{\degree} between all element for both the crosswind and parallel wind.  

\subsection{Crosswind line array settings} \label{sub:des:cros_set}
The idea is to measure the \gls{spl} coverage while playing in the frontal direction, and then measure the \gls{spl} coverage while the line source array is rotated against the wind. The search is then for the least \gls{spl} differences in the coverage area. To be able to ensure that the rotation of the line source array keeps the \gls{spl} in the downwards refraction direction as much as possible, this section designs the directional characteristics settings of the line source array doing the crosswind measurement.

It is founded in \autoref{sec:ana:atm_ref} that downwards refraction raises the \gls{spl} by downwards reflection but the amplification is much less than the attenuation in upwards refraction and is therefore assumed negligible for directionally chose. Therefore, to decide on the horizontal directionally settings is compared in different settings. The comparison uses the founded characteristics directionally of the line source array in \autoref{sec:prop:des_of_lin} and the crosswind measurement in \autoref{sec:ana:atm_ref}

As seen in \autoref{fig:ap:KUDO_25_25_des}, when the speaker is rotated \SI{25}{\degree} up against the wind, which is the rotation where the maximum \gls{spl} is pointed into the outer \dB{-6} coverage angle of the line source array, the downwards direction is lowered from approximately \dB{-6} to approximately \dB{-18}. This rotation occurs an attenuation of \dB{12}, which might be too high. While comparing with \autoref{fig:ap:KUDO_25_55_des} instead, the line source array rotation of \SI{25}{\degree} only attenuation the \gls{spl} in the downwards direction with \dB{6}. 

To decide on a mechanical solution an example is calculated based on the directionality measurement in \autoref{sec:prop:des_of_lin} and the crosswind measurement in \autoref{sec:ana:atm_ref}. The example is based on the optimal rotation for both directionality characteristics, where the difference between the upwards side and the downwards side is smallest. The following paragraph explains and shows the example.


\paragraph{Example} The example shows four cases of the L-Acoustics KUDO line source array. One case where the data from the datasheet is used, one case where the measurement in \autoref{sec:ana:atm_ref} is used. Then two examples where the differences in \gls{spl} is calculated from an rotation of \SI{20}{\degree} for \SI{25}{\degree} / \SI{55}{\degree} settings and a rotation of  \SI{10}{\degree} for \SI{25}{\degree} / \SI{25}{\degree} settings and added to the measurement. The following \autoref{fig:td:mail_lobe_cor} shows the example.


\xfig{design/main_lobe_correction.pdf_t}{The figure shows the main lobe coverage area without rotation in the two lower and with rotation in the two upper}{fig:td:mail_lobe_cor}{1}

The centre \gls{spl} in the measurement in \autoref{fig:td:mail_lobe_cor} was not measured doing the measurement, the stated value is a prediction based on \citep{review_of_sound} which indicate that the energy addition at short distances because of downwards refraction is small compared to the energy loss with upwards refraction. 

As seen in \autoref{fig:td:mail_lobe_cor}, a rotational of \SI{20}{\degree} gives a more homugenius \gls{spl} while the line source array is in \SI{25}{\degree} / \SI{55}{\degree} settings compare the the symetric settings. The diviation from the frontal direction is approximatly \dB{3}. In the other case while the rotation is only \SI{10}{\degree} and the settings is \SI{25}{\degree} / \SI{25}{\degree} the \gls{spl} is also approximately evently spredt but the divination to the frontal direction is much higher. Based on the calculated example, the chosen directionally settings is \SI{25}{\degree} / \SI{55}{\degree} for the measurement. The following \autoref{fig:td:speaker_rot} shows the speaker angle settings for the crosswind measurement as a top wiev. 

\xfig{design/speaker_rotation.pdf_t}{The figure shows the line source array setup for the measurement.}{fig:td:speaker_rot}{1} 

The \autoref{fig:td:speaker_rot} shows the speaker settings versus the wind direction.

\subsection{Parallel wind line array settings}\label{sub:des:par_set}
The idea is to have horizontal symmetric coverage while changing the vertical angle for every measurement. The array is tilted some degree until the optimal angle is measured. The optimal angle is the angle where the shadow zone is pushed as far back as possible concerning the wind speed and the hight of the speaker array. 



\subsection{Microphone position at crosswind}
The microphone position highly depends on the coverage area of the line source element. The line source element which is flown highest covers the back audience, while the line source element which is closest to the ground cover the frontal audience. Therefore, the distance from the speaker to the microphone has to be found based on the knowledge of coverage distance and the minimum distance before refraction. The distances from the stage to the back audience depends on the size of the concert. For a small concert, the main stage covers the full area where for large concert delay tower helps the coverage. Delay tower is often used for a concert where the distances from the stage to the audience is above \SI{50}{\meter} and sometimes up to \SI{73}{\meter} as Roskilde festival \autoref{ap:ques}. The general founded maximum distances from the main stage to the first delay tower is founded to be \SI{73}{\meter} for a huge concert, \SI{50}{\meter} for a large concert and \SI{30}{\meter} for small concert \autoref{ap:ques}. 
Concerning the refraction distances it is shown in \autoref{ta:ana:spl_dif} that refraction occur at a distance of \SI{25}{\meter} with \SI{13}{\meter\per\second}.
Base on the knowledge of the maximum distances founded in \autoref{ap:ques} and the refraction distance, the coverage distances are chosen to be \SI{50}{\meter} for the test, since the used line array flying tools is not able to fly the line array as high as the asked companies, and Roskilde festival is an extreme case concerning the size. The flying height of the line source array in the questioner is about \SI{12}{\meter} to \SI{16}{\meter} where the flying height of the used test setup is only up to \SI{5}{\meter}.  
The hight of the microphone has to be decided based on the audience experience to a concert. To be able to simulate an audience packed area doing the measurement, the following describes the predicted ground reflection characteristics at a concert and how to be able to reproduce it in a measurement. 

Along with a concert, the audience head is assumed to be the new ground plane for high frequency. This assumption is based on the high frequency absorption of the audience founded in \autoref{ana:ground_ref}. Moreover, it is assumed that reflection occurs at low frequency since the audience absorption drops below \Hz{250}. Based on the assumed audience sound reflecting experience, the microphone hight shall optimally be approximately \SI{1.70}{\meter} above the ground with a mechanism which blocks for the high frequency reflection. In \autoref{ds:wind_scr} a windscreen is designed with high frequency reflection blockage and wind noise reduction. This method is tested before the final test to ensure that the reflection blockage work as described. Otherwise, the microphone is situated on the ground to eliminate the ground reflection at high frequency. The microphone is placed with an angle of $\pm$ \SI{25}{\degree} from the frontal direction of the speaker as shown in \autoref{fig:td:ang_mea}.

\xfig{design/angle_measurement.pdf_t}{The figure shows the measurement setup}{fig:td:ang_mea}{1} 

This angle is chosen such that the outer main lobe coverage area is measured and because it is the given directionality angle of the speaker at the narrow-angle settings.  


\subsection{Microphone position at parallel wind}\label{tops:mic_pos_par}
The microphone position of the parallel wind measurement depends on the shadow zone position. It is wanted to measure in the shadow zone to explore if it is possible to move the shadow zone backwards by tilting the line array. Therefore, two measuring scenarios are designed.  The first is based on a realistic tilt angle to a concert, where the coverage area of the line source array covers the microphone position. The second is based on a tilt angle where the coverage area of the line source array is in front of the microphone. The two scenarios are defined as scenarios one and scenarios two, respectively.  By these two methods, the shadow zone is predicted to be present in scenarios one, while the line source array plays against the wind, and in scenarios two the wind refracts the sound wave to the microphone. The following \autoref{fig:td:parallal_n3} shows scenario two.

\xfig{design/parallal_n7.pdf_t}{The figure shows the measurement setup while the line source array is tilted \SI{7}{\degree} forward}{fig:td:parallal_n7}{0.9} 

As seen in \autoref{fig:td:parallal_n7}, the main lobe of the line source array is assumed to be near-field, which only held for high frequencies. At a distances of \SI{40}{\meter} this illustration covers frequencies above \Hz{6000}, frequencies below will be wider as the frequency drops \autoref{sec:ana:geo_spr_los}. The illustration illustrates that the highest power of the line source array is within the centre of the main lobe in the frequency of interest due to the directionality characteristics of the line source array. In this case, the microphone should be outside the main lobe while no refraction is present, but as the wave refract, the microphone becomes inside the main lobe. 

 The following \autoref{fig:td:parallal_n3} illustrate Scenario one.

\xfig{design/parallal_n3.pdf_t}{The figure shows the measurement setup while the line source array is tilted \SI{3}{\degree} forward}{fig:td:parallal_n3}{0.9} 

In the test case shown in \autoref{fig:td:parallal_n3} more \gls{spl} is delivered to the centre and back microphone compare to the test case in  \autoref{fig:td:parallal_n7} while no refraction is present. While upwards refraction is present, the proposed solution in \autoref{sec:des:pro_para} indicate that the refraction refracts the sound wave such as the \gls{spl} distribution is vice versa. The upwards refraction refract the sound wave in \autoref{fig:td:parallal_n7} above the microphone and the refraction of the soundwave in \autoref{fig:td:parallal_n3} refract the soundwave to the microphone. In this test case, the microphone is situated on the ground such that the microphone is as deep in the shadow zone as possible. In other words, as shown in \autoref{fig:td:eddies}, while the microphone is positioned in the same distance from the line source array, while the microphone is on the ground compare to lifted above the ground, the shadow zone is most present at the ground. If more \gls{spl} is present in the \autoref{fig:td:parallal_n7} compare to \autoref{fig:td:parallal_n3} the shadow zone distance might be able to be optimised.

\subsection{Sensors and its position}
Doing the measurement, the temperature, the humidity and the wind direction and speed is measured. All measurement is done syncronised along with the impulse response measurement. The wind is measured into position since the wind condition is dynamic concerning the area. The wind measurement is done close to the speaker and at the centre microphone both in the crosswind measurement and in the parallel wind measurement. The temperature and humidity are only measured in one position near the line source array since the temperature and humidity are assumed to stable and identical at the measuring area. 

Before the measuring system is built, the wind direction is measured to ensure a perfect angle of the speaker. To decide to set up the angle of the measuring system, the wind is measured visually by the directional fan on the anemometer. After the measuring system is built, the anemometer is positioned such that the output angle is ether \SI{90}{\degree} or \SI{270}{\degree}. A headroom of \SI{90}{\degree} before the anemometer goes to ether \SI{0}{\degree} or \SI{359}{\degree}. The reason to have the headroom is that the cross point between \SI{0}{\degree} and \SI{359}{\degree} is a cross point of the measuring potentiometer where it jumps from maximum value to minimum value. The anemometer is further explained in \autoref{des:sensor_mic}


\subsection{Rotation of the line source array}
This section aims to design the turning method for the line source array and ensure that the speaker point in the desired angle. A mechanical solution is chosen for both rotation of the line source array and measuring the rotational angle of the line source array. The mechanical solution to rotate the line source array with a long piece of truss connected to the back of the flying tools of the line source array. By this method, a person can move the other end of truss and stabilise the angle by placing the end of the truss on the ground. Moreover, to ensure that the rotation is as at the specified angle, two laser pointer is attached beneath the line source array â€” one in the vertical rotation axis and one behind the vertical rotational axis. The one on the vertical rotational axis is then the reference to the back laser pointer. The laser points onto a plate where a rotational angle is given. The following \autoref{fig:td:rotation_and_angling} illustrate the solution.

\xfig{design/rotation_and_angling.pdf_t}{The figure shows the rotational mechanic where the blue dashed line illustrate the vertical rotational axis.}{fig:td:rotation_and_angling}{1}  

In \autoref{fig:td:rotation_and_angling} the rotation is achieved by moving the ground position of the rotational truss towards the reader or away from the reader. The laser pointer holder and plate for measuring the angle is shown in the following \autoref{fig:td:mes_ang_plate} and \autoref{fig:td:mes_las_hol}.


\begin{figure}[H]
    \centering
     \captionsetup{width=1\linewidth}
    \begin{minipage}{0.36\textwidth}
        \centering
         \captionsetup{width=0.90\linewidth}
       \input{figures/design/measuring_angle_plate.pdf_t}
        \caption{The figure shows the angle plate.}
        \label{fig:td:mes_ang_plate}
    \end{minipage}%
    \begin{minipage}{0.56\textwidth}
        \centering
         \captionsetup{width=0.90\linewidth}
        \input{figures/design/laser_holder.pdf_t}
        \caption{The figure shows the laser holder.}
        \label{fig:td:mes_las_hol}
    \end{minipage}
\end{figure}


The reference laser is guided intro hole 1 in \autoref{fig:td:mes_las_hol}, which is at the rotational axis while the line source array is tilted \SI{3}{\degree}. The back laser is guided into hole 10 such that the highest distance between the laser is achieved. The measuring angle plate is then placed on the ground with the reference laser pointing at the centre and the back laser pointing at the \SI{0}{\degree} angle while the line source points directly forward. By rotating the line source array, the laser point in the back laser is rotated and gives the rotation of the line source array. 

In the parallel wind measurement, the reference laser is used to measure the tilting angle. While the line source array is in the \SI{3}{\degree} general position, the laser pointer point directly down. The backwards movement of the laser point is calculated to be \SI{44}{\centi\meter} from the general position to  \SI{7}{\degree} downwards tilting.

\subsection{Measuring area and condition}
The measurement is achieved in a flat area with mown grass. The optimal area is without any building or trees, but this optimal area is not possible doing the measurement in this thesis. The second best measuring area is a flat area where only a few building is present, and with no forest but three is allowed in a small number of pieces. The mown grass area beside Tryvej 13, 9320 Hjallerup is chosen because it fits the second best description, and the author has a close relation to the owner of the area.


To keep the wind speed realistic for measurement at concert situation, while refraction is present, the wind speed doing the measurement is limited in the range for average \SI{5}{\meter\per\second} to \SI{10}{\meter\per\second}. Less average wind speed than \SI{5}{\meter\per\second} is avoided to ensure the measurable effect of the wind on sound propagation. The higher limit of the \SI{10}{\meter\per\second} is chosen to ensure that the speaker tower is safe at the hight of \SI{5}{\meter}. The limited size of the line source array tower setup, makes it wind sensitive. Moreover, no rain is allowed to be present in the measuring day.

\subsection{Design of windscreen}\label{ds:wind_scr}
It is founded in \autoref{pre:wind_noise} that wind effect the measurement by pink noise. This noise might not affect the measurement headroom in the refraction frequency range, but an overload of the microphone or preamp by the low frequency noise produces distortion which shall be avoided. Secondly, the signal to noise ration shall be sufficiently high in the frequency range of refraction. Therefore, to be able to control the wind noise, this section design the preferable microphone windscreen configuration for the measurement based on the available equipment in the acoustics lab. 

Only two outside measuring microphone system with two microphones in all is available in acoustics lab, and therefore a windscreen is designed such three identical windscreens can be made. A research of wind speed attenuation, wind noise and frequency effect is done on serval windscreen concept, which is founded in \autoref{ap:desig_screen}. All windscreen is an addition to the original windscreen which always is present on the microphone. 

Based on the finding in \autoref{ap:desig_screen}, the final windscreen optimises the stability of the founded windscreen in \autoref{ap:desig_screen} with a PVC foam mounted on a circular wood plate instead of the Rockwool bat. This configuration shows the best performance in lowering the wind speed near the microphone. Moreover, it is chosen that the microphone shall be at the hight of the ear. Therefore, the wood plate is an additional ground plan added to the bottom of the windscreen to block for ground reflection. The following \autoref{fig:td:mes_win_opt_ver} illustrate the windscreen

\xfig{design/windscreen_optimised.pdf_t}{The figure shows the final designed windscreen for the measurement}{fig:td:mes_win_opt_ver}{1}  

The change from Rockwool bat to PVC foam is made based on the better stability of PVC foam and that the foam wedge is assumed to cancel the reflection from the PVC foam. While adding the wood plate the original windscreen to the microphone is lifted by \SI{4.5}{\centi\meter} from the wood plate which might result in sound reflection from the wood plate. To eliminate the sound reflection from the wood plate, the technique from wind turbine measuring setup is used, where the windscreen is cut. In the wind turbine microphone setup, the cut is done such that half of the microphone is cut down into the wood plate. In the designed windscreen no hemispheres are available, therefore this cut is not suitable. The cut is therefore made \SI{2}{\milli\meter} to \SI{3}{\milli\meter} beneath the microphone opening of the original windscreen such that the original windscreen fully covers the microphone. The cut is illustrated in the following \autoref{fig:td:original_windscreen}. 

\xfig{design/Original_windscreen.pdf_t}{The figure shows the modified original windscreen}{fig:td:original_windscreen}{1}  



\subsection{windscreen wind noise attenuation}\label{sec:ds:wind_noi_att}
This section aims to research the wind noise attenuation produced by the windscreen in real condition to ensure that the wind noise does not overload the microphone. The measurement is done both with and without the designed windscreen to decide if the windscreen works in a real scenario with high speed and directionality changing of the wind. The measurement is furthermore done both in the ear hight and on the ground to research if one position has a better signal to noise ration. The first performed measurement is a series of two measurements, one in the ear hight and one on the ground. Both measurements are performed with the designed windscreen. 

The measurement is done in the same vertical, and horizontal angle in two step, first in ear hight then at the ground with the same windscreen. The measurement is done 10 times at each position, such that to measurement with nearly the same wind speed can be compared. The windscreen is placed \SI{90}{\degree} against the wind, which means that the windscreen is placed in its optimal position where the wind blows directly onto the wide PVC foam plate. The following \autoref{fig:dt:windnoise_with_screen} shows the result. Measurement, where the windscreen is rotated is also performed and can be founded in \autoref{ap:wind_noise_in_design}.

\plot{plot/windnoise_with_screen_dt}{The graph shows the frequency content of the measurement with the windscreen in the hight of the ear and on the ground}{fig:dt:windnoise_with_screen}

As it is seen in \autoref{fig:dt:windnoise_with_screen}, the wind noise highly depends on the hight of the windscreen position. By lowering the windscreen from the ear hight, down to the ground surface, the wind noise is lowered with approximately \dB{20} in the low frequency range, which is the frequency area where the wind noise is highest. Furthermore, it is research if the designed windscreen has higher wind noise attenuation compared to only the modified original windscreen. The following \autoref{fig:dt:windnoise_compare} shows the result.
 
\plot{plot/windnoise_compare}{The graph shows the frequency content of the measurement with and without the windscreen}{fig:dt:windnoise_compare}

As seen in \autoref{fig:dt:windnoise_compare}, the windscreen have generally a \dB{5} to \dB{10} wind noise attenuation. The measurement description is founded in \autoref{ap:wind_noise_in_design}. 



\section{Data logging system} 
This section aims to explain the measuring software and electronic hardware designed for the measurement. To be able to measure the weather condition, measuring hardware has to be chosen and designed. To be able to transfer data from the weather sensors to the measuring software, a small microprocessor is programmed to read sensor data and transfer the data to the measuring software. This section starts to explain the measuring software and its requirements to the weather data transfer protocol. Then the weather sensors are chosen and firmware is designed to a microprocessor. In the end, the hardware is designed.

\subsection{Software}
This section gives a short overview of the \matlab software used for the measurement. The overview does not include any code but only the method of measuring the impulse response and get nearly synchronised data from the serial bus. This section starts explaining the data transfer between the sound card and the computer and the weather hardware to the computer. Both part are connected via \gls{usb} connection. Afterwards, the impulse measuring method is explained.

The data transfer rate between the soundcard and weather hardware to the computer is decided by the buffer length of the audio signal. The audio signal is not allowed to lack while measuring the impulse response. \matlab transfer a buffer with audio to the sound card and gets a buffer back with measured signal. The played and recorded signal is syncronised. After the buffer is received \matlab have a short period to do calculations, but the calculation shall be finish, and the next audio buffer shall be sent between two samples.  The chosen buffer size between \matlab and the soundcard is 4096 sample. The following \autoref{fig:td:fifo:com_protocol} illustrate the data transfer protocol.

\xfig{design/com_protocol.pdf_t}{The figure shows the transferring samples between the sound card and computer and between the serial bus and the computer. The length of the buffer boxes is just an illustration, the actual length is not measured.}{fig:td:fifo:com_protocol}{1}  

As seen in \autoref{fig:td:fifo:com_protocol}, the length of the buffer size limits the amount of weather data. The sound sweep measurement which is explained next is chosen to be \SI{5}{\second} long. This gives 55 weather data measurement point doing the impulse response measurement. All weather information and sound information is stored into a mat file after every measurement such that the analysis can be done offline.

The impulse response is measured with sine sweep according to \citep{mller2001transfer}. The method is to deconvolute the measured signal by the reference signal which produces the impulse response of the speaker. In the measuring software, the deconvolution is done in the frequency domain, because it speeds up the calculation. A hanning window windows both the measured signal and the reference signal. To exclude the influence of the sound card, the reference signal is played through one output channel and measured by one of the microphone input. It is assumed that the characteristic of every output and input is equal. To be able to make calibrated impulse responses, the measured reference signal is related to the microphone sensitivity by the following \autoref{eq:relate}

\begin{equation}\label{eq:relate}
\text{ref}_{s} = \text{ref}_{m} \cdot    \frac{\text{mic}_{sen}}{rms(\text{ref}_{m})}
\end{equation}

\startexplain
\explain{\text{ref}_{s}}{is the calibrated reference signal}{1}
\explain{\text{ref}_{m}}{is the measured reference signal}{1}
\explain{\text{mic}_{sen}}{is the rms sensitivity of the microphone in digital number at one pascal rms}{1}
\stopexplain

After the reference signal is related to the measured signal, deconvolution is calculated by calculating the \gls{fft} for both signal, divide the measured signal by the reference signal and calculate the \gls{ifft}. The result is an impulse response where the amplitude corresponds to a calibrated pascal value of the played time signal. By the impulse response both the $l_{eq}$ and the frequency response can be calculated. The calibrated frequency response is calculated with the \matlab function \texttt{freqz}. The $l_{eq}$ is calculated with the following \autoref{topd:leq}.


\begin{equation}\label{topd:leq}
L_{eq} = 10 \cdot log10 \left ( \frac{1}{T} \cdot \frac{\int IR^2}{20\mu^2 } \right )
\end{equation}

\startexplain
\explain{L_{eq}}{is the calibrated equivalent sound pressure level}{\db}
\explain{IR}{is the impulse response}{\pascal}
\explain{20\mu}{is the hearing threshold level reference}{\pascal}
\explain{T}{is the measured time period. In this case while it is an impulse response, the time period is always set to 1 no matter how long the sine sweep is designed to be}{\second}
\stopexplain

As an example, if the played signal is from \Hz{20} to \SI{20}{\kilo\hertz} and it is measured that all frequency is \dB{94}, the $L_{eq}$ gives \dB{94}.

The measuring software is founded in  \autoref{ap:imp_res_meas_soft}


\subsection{Sensor and microprocessor}\label{des:sensor_mic}
The microprocessor for weather measurement is based on an Arduino UNO. The chose of an Arduino is made because code for both the temperature and humidity sensor and the used anemometer is available on the internet.  

The chosen temperature and humidity sensor are an AM2302 because it is available as a component at Aalborg University and it covers relative humidity from \SI{0}{\percent} to \SI{100}{\percent} and a temperature range from \SI{-40}{\celsius} to \SI{80}{\celsius} which is more than enough of the measurement. The data sheet of the sensor is founded in \citep{temp_sens}.


The chosen anemometer is a Davis Vantage Pro2 anemometer. This anemometer is chosen because the connection is direct to the wind speed sensor and the wind direction sensor. The direction sensor is a \SI{20}{\kilo\ohm} \SI{360}{\degree} potentiometer, where the speed sensor is a contact which makes one short circuit to ground for every rotation. The directional sensor can, therefore, be connected to an analogue input port where the speed sensor is connected to a digital input. The data sheet for the anemometer is founded in \citep{anemometer_sens}



\subsection{Firmware}
The firmware is designed to support two anemometers, one temperature sensor and one humidity sensor.
The temperature and humidity sensor is one unit and communicates digitally to the Arduino. The communication is done through the dht.h Arduino library. The data is then called from a function of the library, and the author has not designed the digital connection. 
The anemometer both measure the wind direction and wind speed. The wind direction is an analogue voltage from \SI{0}{\volt} to \SI{5}{\volt} while the angle goes from \SI{0}{\degree} to \SI{359}{\degree}. The rotational angle from the direction sensor increases while the directional goes from south to west, therefore it works in the same direction like a compass. The analogue voltage is measured with the build in 10 bit \gls{adc} which gives a digital number from 0 to 1024. This measured number is transferred directly to the com bus without angle correction. The conversion to angle is done in \matlab . 

The wind speed measurement sensor gives a pulse for every rotation. According to the datasheet of the wind anemometer, one rotation of the wind speed sensor over a time period of \SI{1}{\second} correspond \SI{1.0058}{\meter\per\second}. To be able to measure the wind speed in a higher resolution that \SI{1.0058}{\meter\per\second} the pulses is time average over a defined period. To be able to measure over a period a \gls{fifo} buffer is designed for the pulses as shown in the following \autoref{fig:td:fifo:buffer} 
\xfig{design/fifo_buffer.pdf_t}{The figure shows the \gls{fifo} buffer system for wind speed measurement}{fig:td:fifo:buffer}{1}  

As seen in \autoref{fig:td:fifo:buffer}, the update time is for every \SI{185}{\milli\second} and the buffer contains 16 pieces of \SI{185}{\milli\second} which gives an average time over \SI{2.96}{\second}. This buffer size gives a wind speed resolution of \SI{339.8}{\milli\meter\per\second}. 

The update time is slower than the data transfer time interval between the Arduino and \matlab.  This resolution is decided to be sufficient since the mechanic of the speed sensor by itself average the wind speed.

The firmware is synchronised with \matlab by adding a delay in the main loop and not tricking on a timer. Therefore, the program runtime is only stable down to $\pm$ \SI{3}{\milli\second} precision with a mean update time for the firmware of \SI{92.3}{\milli\second}. The mean update time is based on five time measurement with 80 samples in each. The negative shift of the firmware update doing the 55 weather update transferred to \matlab gives a lack of \SI{-38.8}{\milli\second} after end measurement.  The lack of \SI{-38.8}{\milli\second} is much less than the update of \SI{-92.3}{\milli\second}, which indicate that the time synchronisation lack is less than one sample and no time shift is present. Since the update sometimes is above \SI{92.9}{\milli\second} the weather updates sample to \matlab can be the same twice. This issue is only present in the first 5 samples. After those samples, the lack in synchronisation does that 96 ms is an update before the \matlab is ready to receive data from the serial bus.

Based on the above explanation, the following weather data is present in the impulse response measurement, where it shall be noted that within the first few samples, an repetition can occur. This repetition is considered as indifferent, since the first \SI{500}{\milli\second} is a starting silence period of the sine sweep and frequency below \SI{40}{\hertz} and, therefore, is removed from the data analysis. 

\begin{itemize}
\item The wind direction is updated for every weather sample.  
\item The wind speed is updated for every second weather sample.
\item The temperature and humidity are updated for every weather sample.
\item The \matlab software ask in total for 55 weather samples doing one impulse response measurement. 
\end{itemize}

The data transfer is done through the serial bus vis \gls{usb} connection. The following \autoref{tp:com_snapshot} shows a snapshot of the serial bus delivered by the Arduino.


\begin{figure}[H]
\centering
      \captionsetup{width=0.57\linewidth}
      \footnotesize
\begin{tabular}{llllll}
Speed 1 & Direc 1 & Speed 2 & Direc 2 & Temp  & Hum   \\ \hline
5.44    & 790     & 6.12    & 884     & 21.90 & 68.90 \\
5.44    & 791     & 6.12    & 882     & 21.90 & 68.90 \\
4.42    & 790     & 5.78    & 863     & 21.90 & 68.90 \\
4.42    & 791     & 5.78    & 832     & 21.90 & 68.90 \\
3.74    & 790     & 5.44    & 820     & 21.90 & 68.90 \\
3.74    & 790     & 5.44    & 827     & 21.90 & 68.90 \\
3.40    & 791     & 5.10    & 831     & 21.90 & 68.90 \\
3.40    & 790     & 5.10    & 832     & 21.90 & 68.90
\end{tabular}
\caption{The figure shows a snapshot of the serial bus. The first vertical line, which is the left vertical data line is the wind speed of the first anemometer.  The second vertical line is the wind direction of the first anemometer. The third vertical line is the wind speed of the second anemometer.  The fourth vertical line is the wind direction of the second anemometer. The fifth vertical line is the temperature and the last vertical line is the humidity.}
\label{tp:com_snapshot}
\end{figure}%


The firmware is founded in \autoref{ap:wet_code}


\subsection{Hardware}

To be able to connect both the two anemometers and the temperature and humidity sensor to the Arduino UNO an Arduino shield is designed. The shield is designed such that is can be plugged directly onto the Arduino. The following \autoref{fig:td:ard_shield} shows the schematic of the shield and the \gls{pcb}


\dfig{ard_schematic.pdf}{The figure shows the schematic of the shield}{ard_shield.pdf}{The figure shows the \gls{pcb} layout of the shield}{Ardouino shield design}{fig:td:ard_shield}{0.62}{0.38}


The to resistors in \autoref{fig:td:ard_shield} R1 and R2 is pull-up resistors for the wind speed contact with a resistance of \SI{4.7}{\kilo\ohm}. While the contact in the anemometer is not shorted, the voltage at the input pin on the Arduino is \SI{5}{\volt}. While the contact is shorted the voltage is \SI{0}{\volt}. The two RJ11 connectors are for the Anemometer connection. The six test point is soldering connection to the temperature and humidity sensor. 

All hardware can be seen in \autoref{ap:hardware}






